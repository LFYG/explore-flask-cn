

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>视图和路由的高级模式 &mdash; Explore Flask 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Explore Flask 1.0 documentation" href="index.html"/>
        <link rel="next" title="蓝图" href="blueprints.html"/>
        <link rel="prev" title="配置" href="configuration.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Explore Flask</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">前言</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id2">假设</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id8">动态文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id9">本书使用的约定</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id13">彩蛋</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id14">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">编码约定</a><ul>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#pep">让我们来个 PEP 动员！</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#id3">相对导入</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#id4">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">环境</a><ul>
<li class="toctree-l2"><a class="reference internal" href="environment.html#virtualenv">使用 virtualenv 管理你的环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id6">版本控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id8">调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id12">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="organizing.html">组织你的项目</a><ul>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id2">定义</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id4">组织模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id10">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">配置</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id2">简单的例子</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id3">实例文件夹</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id8">基于环境变量配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">视图和路由的高级模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">视图装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="#url-converters">URL 转换器(converters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="blueprints.html">蓝图</a><ul>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id2">什么是蓝图？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id3">为什么要使用蓝图？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id5">你把它们放哪里？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id9">你如何使用它们？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id12">使用蓝图重构小的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id18">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">模板</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates.html#jinja">Jinja 快速入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id3">如何组织模板</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id4">继承</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id6">创建宏</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id9">自定义过滤器</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id11">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="static.html">静态文件</a><ul>
<li class="toctree-l2"><a class="reference internal" href="static.html#id2">组织你的静态文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#flask-assets">使用 Flask-Assets 管理静态资源</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#id7">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="storing.html">存储数据</a><ul>
<li class="toctree-l2"><a class="reference internal" href="storing.html#sqlalchemy">SQLAlchemy</a></li>
<li class="toctree-l2"><a class="reference internal" href="storing.html#id5">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="forms.html">处理表单</a><ul>
<li class="toctree-l2"><a class="reference internal" href="forms.html#flask-wtf">Flask-WTF</a></li>
<li class="toctree-l2"><a class="reference internal" href="forms.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="users.html">处理用户的模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="users.html#id2">确认电子邮箱</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id3">存储密码</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id5">认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id7">忘记密码</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id8">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">部署</a><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id2">主机</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id3">部署方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id7">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">结尾</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Explore Flask</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>视图和路由的高级模式</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/views.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="id1">
<h1>视图和路由的高级模式<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<img alt="Advanced patterns for views and routing" src="_images/views.png" />
<div class="section" id="id2">
<h2>视图装饰器<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Python 装饰器是用于转换其它函数的函数。当一个装饰的函数被调用的时候，装饰器也会被调用。接着装饰器就会采取行动，修改参数，停止执行或者调用原始函数。我们可以使用装饰器来包装视图，让它们在执行之前运行我们希望的代码。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@decorator_function</span>
<span class="k">def</span> <span class="nf">decorated</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<p>如果你已经浏览了 Flask 教程，在这个代码块的语法看起来很熟悉。<code class="docutils literal"><span class="pre">&#64;app.route</span></code> 是用于为 Flask 应用程序的视图函数匹配 URLs 的装饰器。</p>
<p>让我们看看其它的装饰器，你可能会在你的 Flask 应用中使用到它们。</p>
<div class="section" id="id3">
<h3>认证<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Flask-Login 扩展可以很容易地实现登录系统。除了处理用户认证的细节，Flask-Login 提供给我们一个装饰器，它用来限制只允许登录的用户访问某些视图：
<code class="docutils literal"><span class="pre">&#64;login_required</span></code>。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># app.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">current_user</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;index.html&quot;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/dashboard&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">account</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;account.html&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">&#64;app.route</span></code> 应该是外层的视图装饰器（换句话说，<code class="docutils literal"><span class="pre">&#64;app.route</span></code> 应该在所有装饰器的最前面）。</p>
</div>
<p>一个登录过的用户才能够访问 <em>/dashboard</em> 路由。我们可以配置 Flask-Login，让未登录的用户重定向到一个登陆页，返回一个 HTTP 401 状态码或者我们想要它做的任何东西。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">了解更多使用 Flask-Login 的内容，请参阅 <a href="#id4"><span class="problematic" id="id5">`</span></a>官方文档 &lt;<a class="reference external" href="http://flask-login.readthedocs.org/en/latest/">http://flask-login.readthedocs.org/en/latest/</a>&gt;`_（中文翻译文档位于：<a class="reference external" href="http://www.pythondoc.com/flask-login/index.html">http://www.pythondoc.com/flask-login/index.html</a>）。</p>
</div>
</div>
<div class="section" id="id6">
<h3>缓存<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>想象下在 CNN 以及其它一些新闻网站提到我们的应用，我们正在接受每秒数千次的请求。我们的主页针对每一次请求都要多次访问数据库，因此所有这些因素都会导致系统越来越慢，用户访问等待的时间越来越长。如何才能加快访问速度，让所有的访客都不会错过我们的网站？</p>
<p>有很多好的答案，但是这一章是关于缓存，因此我们就来讨论它。确切地来说，我们将要使用 <a class="reference external" href="http://pythonhosted.org/Flask-Cache/">Flask-Cache</a> 扩展。这个扩展提供我们一个装饰器，我们可以在我们的首页视图上使用这个装饰器用来在一段时间内缓存响应。</p>
<p>Flask-Cache 可以被配置成与一堆不同的缓存后端一起工作。一个流行的选择是 <a class="reference external" href="http://redis.io/">Redis</a>，Redis 很容易设置和使用。假设 Flask-Cache 已经配置好，这个代码块显示我们的缓存装饰器视图是什么样子的。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># app.py</span>

<span class="kn">from</span> <span class="nn">flask.ext.cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">()</span>

<span class="c"># We&#39;d normally include configuration settings in this call</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="nd">@cache.cached</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="c"># Make a few database calls to get the information we need</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s">&#39;index.html&#39;</span><span class="p">,</span>
        <span class="n">latest_posts</span><span class="o">=</span><span class="n">latest_posts</span><span class="p">,</span>
        <span class="n">recent_users</span><span class="o">=</span><span class="n">recent_users</span><span class="p">,</span>
        <span class="n">recent_photos</span><span class="o">=</span><span class="n">recent_photos</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>现在函数将每 60 秒会执行一次，因为 60 秒后缓存就过期。响应将会保存在我们的缓存中，在缓存没有过期之前，所有针对首页的请求都会直接从缓存中拉取。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Flask-Cache 也为我们提供了 <strong>memoize</strong> 函数 — 或者缓存一个函数被某些参数调用的结果。你甚至可以缓存计算开销很高的 Jinja2 模板片段。</p>
</div>
</div>
<div class="section" id="id7">
<h3>自定义装饰器<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>对于本章节，先让我们想象我们有一个应用程序，该应用程序每个月都会向用户收费。如果用户的账号已经过期，我们将会重定向到收费页面并且让用户升级。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># myapp/util.py</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flash</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>

<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span>

<span class="k">def</span> <span class="nf">check_expired</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">current_user</span><span class="o">.</span><span class="n">account_expires</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">&quot;Your account has expired. Update your billing info.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;account_billing&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decorated_function</span>
</pre></div>
</td></tr></table></div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>10</td>
<td>当一个函数使用 <code class="docutils literal"><span class="pre">&#64;check_expired</span></code> 装饰，<code class="docutils literal"><span class="pre">check_expired()</span></code> 被调用并且被装饰的
函数被作为参数进行传递。</td>
</tr>
<tr class="row-even"><td>11</td>
<td><code class="docutils literal"><span class="pre">&#64;wraps</span></code> 是一个装饰器，它做了一些工作使得 <code class="docutils literal"><span class="pre">decorated_function()</span></code> 看起来像
<code class="docutils literal"><span class="pre">func()</span></code>。这使得函数的行为多了几分自然。</td>
</tr>
<tr class="row-odd"><td>12</td>
<td><code class="docutils literal"><span class="pre">decorated_function</span></code> 竟会获取所以偶我们传递给原始视图函数 <code class="docutils literal"><span class="pre">func()</span></code>
的 args 和 kwargs。我们在这里检查用户的账号是否过期。如果已经过期的话，
我们将会闪现一条消息并且重定向到一个收费页面。</td>
</tr>
<tr class="row-even"><td>16</td>
<td>现在我们已经做了我们想要做的事情，我们使用它原始的参数运行被装饰的视图函数
<code class="docutils literal"><span class="pre">func()</span></code>。</td>
</tr>
</tbody>
</table>
<p>当我们叠加装饰器的时候，最上层的装饰器会首先运行，接着调用下一行的下一个函数：要么是视图函数，要么就是装饰器。装饰器的语法只是 Python 提供的一个语法糖。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># This code:</span>
<span class="nd">@foo</span>
<span class="nd">@bar</span>
<span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="n">r1</span> <span class="o">=</span> <span class="n">one</span><span class="p">()</span>

<span class="c"># is the same as this code:</span>
<span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="n">two</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">(</span><span class="n">two</span><span class="p">))</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">two</span><span class="p">()</span>

<span class="n">r1</span> <span class="o">==</span> <span class="n">r2</span> <span class="c"># True</span>
</pre></div>
</td></tr></table></div>
<p>此代码块展示了一个使用我们自定义的装饰器和来自 Flask-Login 扩展的 <code class="docutils literal"><span class="pre">&#64;login_required</span></code> 装饰器的示例。我们可以通过叠加使用多个装饰器。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># myapp/views.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">check_expired</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/use_app&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="nd">@check_expired</span>
<span class="k">def</span> <span class="nf">use_app</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Use our amazing app.&quot;&quot;&quot;</span>
    <span class="c"># [...]</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;use_app.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/account/billing&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">account_billing</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Update your billing info.&quot;&quot;&quot;</span>
    <span class="c"># [...]</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;account/billing.html&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>现在当一个用户试图访问 <em>/use_app</em>，<code class="docutils literal"><span class="pre">check_expired()</span></code> 将会确保在运行视图函数之前用户的账号没有过期。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://docs.python.org/2/library/functools.html#functools.wraps">在 Python 文档</a> 中阅读更多关于 <code class="docutils literal"><span class="pre">wraps()</span></code> 函数工作原理的内容.</p>
</div>
</div>
</div>
<div class="section" id="url-converters">
<h2>URL 转换器(converters)<a class="headerlink" href="#url-converters" title="Permalink to this headline">¶</a></h2>
<div class="section" id="converters">
<h3>内置转换器(converters)<a class="headerlink" href="#converters" title="Permalink to this headline">¶</a></h3>
<p>当你在 Flask 中定义路由的时候，你可以指定路由的一部分，它们将会转换成 Python 变量并且传递到视图函数。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;username&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<p>在 URL 中的 <code class="docutils literal"><span class="pre">&lt;username&gt;</span></code> 将会作为 username 参数传入到视图。你也可以指定一个转换器，用来在变量传入视图之前对其进行过滤筛选。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/id/&lt;int:user_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</td></tr></table></div>
<p>在这个代码块中，URL <em>http://myapp.com/user/id/Q29kZUxlc3NvbiEh</em> 将会返回一个 404 状态码 &#8211; 未找到。这是因为 URL 中的 user_id 要求的是一个整数但实际上是一个字符串。</p>
<p>我们也可以有第二个视图用来处理 user_id 为字符串，<em>/user/id/Q29kZUxlc3NvbiEh/</em> 可以调用该视图而 <em>/user/id/124</em> 可以调用第一个视图。</p>
<p>本表格显示了 Flask 内置的 URL 转换器。</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>string</td>
<td>接受不带斜杠（默认值）的任何文本。</td>
</tr>
<tr class="row-even"><td>int</td>
<td>接受整数。</td>
</tr>
<tr class="row-odd"><td>float</td>
<td>像 int，但是接受浮点值。</td>
</tr>
<tr class="row-even"><td>path</td>
<td>像字符串，但是接受斜杠。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id8">
<h3>自定义转换器(converters)<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>我们也能准备自定义转换器来满足自己的需求。在 Reddit 上 — 一个受欢迎的链接共享网站 — 用户创建和主持的以主题为基础的讨论和链接共享的社区。例如，/r/python 和 /r/flask 就是分别用 URL：<em>redit.com/r/python</em> 和 <em>reddit.com/r/flask</em> 来表示。Reddit 一个有意思的功能就是你可以查看多个 subreddits 的文章，通过在 URL 中使用加号（+）来连接每一个 subreddits 的名称，例如，<em>reddit.com/r/python+flask</em>。</p>
<p>我们可以在我们自己的 Flask 应用程序中使用一个自定义的转换器来实现这个功能。我们将接受通过加号（+）分离的任意数量的元素，转换它们成一个列表（这里实现了一个叫做 <code class="docutils literal"><span class="pre">ListConverter</span></code> 的类）并且把列表元素传给视图函数。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># myapp/util.py</span>

<span class="kn">from</span> <span class="nn">werkzeug.routing</span> <span class="kn">import</span> <span class="n">BaseConverter</span>

<span class="k">class</span> <span class="nc">ListConverter</span><span class="p">(</span><span class="n">BaseConverter</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BaseConverter</span><span class="o">.</span><span class="n">to_url</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>我们需要定义两个方法：<code class="docutils literal"><span class="pre">to_python()</span></code> 和 <code class="docutils literal"><span class="pre">to_url()</span></code>。正如名称暗示的一样，<code class="docutils literal"><span class="pre">to_python()</span></code> 是用于转换 URL 中的路径成为一个 Python 对象，该对象将会传递给视图；<code class="docutils literal"><span class="pre">to_url()</span></code> 是被 <code class="docutils literal"><span class="pre">url_for()</span></code> 用来把参数转换为合适的形式的 URL。</p>
<p>为了使用我们 <code class="docutils literal"><span class="pre">ListConverter</span></code>，我们首先必须告诉 Flask 它的存在。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># /myapp/__init__.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">ListConverter</span>

<span class="n">app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">converters</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ListConverter</span>
</pre></div>
</td></tr></table></div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>这里可能有机会碰到循环导入的问题如果你的 <code class="docutils literal"><span class="pre">util</span></code> 模块有 <code class="docutils literal"><span class="pre">from</span> <span class="pre">.</span> <span class="pre">import</span> <span class="pre">app</span></code> 这一行。这是我为什么要等到 app 已经初始化后才导入
<code class="docutils literal"><span class="pre">ListConverter</span></code>。</p>
<p class="last">现在我们就可以像使用内置的转换器一样使用自己的转换器。我们可以在 <code class="docutils literal"><span class="pre">&#64;app.route()</span></code> 中使用 “list”，就像使用内置的 int，float，string，path 一样。</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># myapp/views.py</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/r/&lt;list:subreddits&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">subreddit_home</span><span class="p">(</span><span class="n">subreddits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show all of the posts for the given subreddits.&quot;&quot;&quot;</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subreddit</span> <span class="ow">in</span> <span class="n">subreddits</span><span class="p">:</span>
        <span class="n">posts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subreddit</span><span class="o">.</span><span class="n">posts</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;/r/index.html&#39;</span><span class="p">,</span> <span class="n">posts</span><span class="o">=</span><span class="n">posts</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>这应该会像 Reddit 的多 reddit 系统一样工作。同样的方法可以被使用来做我们向往的任何 URL 转换。</p>
</div>
</div>
<div class="section" id="id9">
<h2>摘要<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Flask-Login 中的 <code class="docutils literal"><span class="pre">&#64;login_required</span></code> 装饰器帮助你限制只允许登录的用户访问视图。</li>
<li>Flask-Cache 扩展为你提供了大量的装饰器用来实现各种的缓存方法。</li>
<li>我们能够开发自定义视图装饰器用来帮助我们组织代码并且坚持 DRY（不要重复你自己）的编码原则。</li>
<li>自定义的 URL 转换器是实现涉及到 URL 的创新功能的一个很好的方式。</li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="blueprints.html" class="btn btn-neutral float-right" title="蓝图"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configuration.html" class="btn btn-neutral" title="配置"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Robert Picard.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50579609-1', 'exploreflask.com');
  ga('send', 'pageview');

</script>


</body>
</html>