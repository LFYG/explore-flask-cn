

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>处理用户的模式 &mdash; Explore Flask 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Explore Flask 1.0 documentation" href="index.html"/>
        <link rel="next" title="部署" href="deployment.html"/>
        <link rel="prev" title="处理表单" href="forms.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Explore Flask</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">前言</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id2">假设</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id8">动态文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id9">本书使用的约定</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id13">彩蛋</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id14">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">编码约定</a><ul>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#pep">让我们来个 PEP 动员！</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#id3">相对导入</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#id4">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">环境</a><ul>
<li class="toctree-l2"><a class="reference internal" href="environment.html#virtualenv">使用 virtualenv 管理你的环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id6">版本控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id8">调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id12">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="organizing.html">组织你的项目</a><ul>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id2">定义</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id4">组织模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id10">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">配置</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id2">简单的例子</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id3">实例文件夹</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id8">基于环境变量配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views.html">视图和路由的高级模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views.html#id2">视图装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="views.html#url-converters">URL 转换器(converters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="views.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="blueprints.html">蓝图</a><ul>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id2">什么是蓝图？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id3">为什么要使用蓝图？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id5">你把它们放哪里？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id9">你如何使用它们？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id12">使用蓝图重构小的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id18">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">模板</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates.html#jinja">Jinja 快速入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id3">如何组织模板</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id4">继承</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id6">创建宏</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id9">自定义过滤器</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id11">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="static.html">静态文件</a><ul>
<li class="toctree-l2"><a class="reference internal" href="static.html#id2">组织你的静态文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#flask-assets">使用 Flask-Assets 管理静态资源</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#id7">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="storing.html">存储数据</a><ul>
<li class="toctree-l2"><a class="reference internal" href="storing.html#sqlalchemy">SQLAlchemy</a></li>
<li class="toctree-l2"><a class="reference internal" href="storing.html#id5">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="forms.html">处理表单</a><ul>
<li class="toctree-l2"><a class="reference internal" href="forms.html#flask-wtf">Flask-WTF</a></li>
<li class="toctree-l2"><a class="reference internal" href="forms.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">处理用户的模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">确认电子邮箱</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">存储密码</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">忘记密码</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">部署</a><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id2">主机</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id3">部署方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id7">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">结尾</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Explore Flask</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>处理用户的模式</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/users.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="id1">
<h1>处理用户的模式<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<img alt="Patterns for handling users" src="_images/users.png" />
<p>一个现代 web 应用程序需要做的最常见的事情就是处理用户。拥有基本账号功能的一个应用程序需要处理很多的事情，像注册，确认电子邮箱，安全地存储密码，安全地重置密码，认证等等。因为在处理用户的时候存在很多安全的问题，通常最佳的方式就是坚持在这个领域中的标准模式。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在本节中，我们假设你是使用 SQLAlchemy 模型以及 WTForms 来处理你的表单输入。如果你没有使用这些的话，你需要自己使你的首选方法适应这些模式。</p>
</div>
<div class="section" id="id2">
<h2>确认电子邮箱<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>当一个新用户提供我们他们的邮箱，我们通常要确认他们提供给我们的邮箱是否是正确的。一旦我们已经通过邮箱验证，我们可以安心地给我们用户发送密码重置连接以及其它敏感的信息，而无需担心是谁在接收这些内容。</p>
<p>确认邮箱最常见的模式之一就是发送一个 URL 唯一的密码重置链接，当访问它的时候，证实了用户的邮箱地址。例如，<a class="reference external" href="mailto:john&#37;&#52;&#48;gmail&#46;com">john<span>&#64;</span>gmail<span>&#46;</span>com</a> 注册了我们的应用程序。我们把他的用户数据插入到数据库中，该条用户数据的 <code class="docutils literal"><span class="pre">email_confirmed</span></code> 字段被设置成 <code class="docutils literal"><span class="pre">False</span></code> 并且发送了一封携带唯一的 URL 的邮件到 <a class="reference external" href="mailto:john&#37;&#52;&#48;gmail&#46;com">john<span>&#64;</span>gmail<span>&#46;</span>com</a> 上。这个 URL 通常包含一个唯一的令牌，例如，<em>http://myapp.com/accounts/confirm-/Q2hhZCBDYXRsZXR0IHJvY2tzIG15IHNvY2tz</em>。当 John 收到这封邮件的时候，他点击链接。我们的应用程序会检查令牌，知道谁在确认邮箱并且设置 John 的 <code class="docutils literal"><span class="pre">email_confirmed</span></code> 字段为 <code class="docutils literal"><span class="pre">True</span></code>。</p>
<p>我们是如何知道 URL 中的令牌是对应哪个用户？一种方式就是在令牌被创建的时候存储到数据库中，当我们收到确认请求的时候到数据库中检查对比。这是一个很大的开销，幸运地是，我们不必这么做。</p>
<p>我们会对邮箱地址编码成令牌。并且令牌也包含一个时间戳，该时间戳是让我们设置一个令牌在什么时间内有效的时间限制。为了完成这些，我们使用 <code class="docutils literal"><span class="pre">itsdangerous</span></code> 包。这个包提供我们一个用来发送敏感数据到一个不可信的环境的工具（像发送一封邮件确认令牌到一个未确认的邮箱）。在本例中，我们将会使用 <code class="docutils literal"><span class="pre">URLSafeTimedSerializer</span></code> 类的一个实例。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/util/security.py</span>

<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">URLSafeTimedSerializer</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;SECRET_KEY&quot;</span><span class="p">])</span>
</pre></div>
</td></tr></table></div>
<p>当一个用户给我们他们的邮箱地址的时候，我们可以使用它序列化来生成一个确认令牌。我们实现了一个简单的账号创建过程，里面就使用了这种方法。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/views.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">url_for</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">EmailPasswordForm</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">ts</span><span class="p">,</span> <span class="n">send_email</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/accounts/create&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_account</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EmailPasswordForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c"># Now we&#39;ll send the email confirmation link</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s">&quot;Confirm your email&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s">&#39;email-confirm-key&#39;</span><span class="p">)</span>

        <span class="n">confirm_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span>
            <span class="s">&#39;confirm_email&#39;</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s">&#39;email/activate.html&#39;</span><span class="p">,</span>
            <span class="n">confirm_url</span><span class="o">=</span><span class="n">confirm_url</span><span class="p">)</span>

        <span class="c"># We&#39;ll assume that send_email has been defined in myapp/util.py</span>
        <span class="n">send_email</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;index&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;accounts/create.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>我们上面定义的视图处理用户的创建以及发送一封邮件到指定的邮箱地址。你可能注意到我们使用了一个模板用来生成邮件内容的 HTML 形式。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre>{# ourapp/templates/email/activate.html #}

Your account was successfully created. Please click the link below&lt;br&gt;
to confirm your email address and activate your account:

&lt;p&gt;
&lt;a href=&quot;{{ confirm_url }}&quot;&gt;{{ confirm_url }}&lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;
--&lt;br&gt;
Questions? Comments? Email hello@myapp.com.
&lt;/p&gt;
</pre></div>
</td></tr></table></div>
<p>好了，现在我们只需要实现一个处理邮件中确认链接的视图。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/views.py</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/confirm/&lt;token&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">confirm_email</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s">&quot;email-confirm-key&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">86400</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_404</span><span class="p">()</span>

    <span class="n">user</span><span class="o">.</span><span class="n">email_confirmed</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;signin&#39;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>这个视图是一个简单的表单视图。我们只在开始的时候添加了 <code class="docutils literal"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">except</span></code> 来检查令牌是否有效。令牌中包含了一个时间戳，因此我们能够告诉 <code class="docutils literal"><span class="pre">ts.loads()</span></code> 引发一个异常如果它大于 <code class="docutils literal"><span class="pre">max_age</span></code> 的话。在本例中，我们设置 <code class="docutils literal"><span class="pre">max_age</span></code> 为 86400 秒，即：24小时。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">你可以使用非常相似的方法来实现更新邮箱地址的功能。只要发送一封携带令牌的邮件到新的邮箱，该令牌包含旧的以及新的邮箱地址。如果令牌是有效的，用新的邮箱更新旧的邮箱。</p>
</div>
</div>
<div class="section" id="id3">
<h2>存储密码<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>处理用户的首要规则就是在存储密码之前用 Bcrypt（或者 scrypt，这里我们使用 Bcrypt）散列密码。我们绝不能明文存储密码。这是一个巨大的安全问题并且对于我们用户来说是不公平的。所有的这些辛勤工作都已经有人完成并且抽象出来给我们使用，所以没有理由不在这里遵循最佳实践。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OWASP 是关于 Web 应用程序安全性的信息的业界最值得信赖的来源之一。看看一些他们 <a class="reference external" href="https://www.owasp.org/index.php/Secure_Coding_Cheat_Sheet#Password_Storage">关于安全编码的建议</a>。</p>
</div>
<p>我们将继续并且使用 Flask-Bcrypt 扩展在我们的应用中实现 bcrypt 包。这个包基本上是对 <code class="docutils literal"><span class="pre">py-bcrypt</span></code> 包的封装，但是为我们做了一些很烦人的事情（像在比较散列之前检查字符编码等等）。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/__init__.py</span>

<span class="kn">from</span> <span class="nn">flask.ext.bcrypt</span> <span class="kn">import</span> <span class="n">Bcrypt</span>

<span class="n">bcrypt</span> <span class="o">=</span> <span class="n">Bcrypt</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Bcrypt 算法强烈地被推荐的原因之一就是”未来的适应性“。这就意味着随着时间的推移，当计算能力变得越来越便宜的时候，我们可以把它变得越来越困难地被使用猜测上百万次密码这一种暴力方式来破解。我们使用越多的”循环“来散列密码，将会花费越多的时间来猜测。如果我们在存储密码之前使用算法散列密码 20 次的话，攻击者必须散列每一个它们的猜测 20 次。</p>
<p>请记住如果我们散列密码超过 20 次的话，我们的应用程序需要花费很长的一段时间来返回响应，具体要取决于什么时候处理完成。这就意味着当选择使用的”循环数“的时候，我们必须平衡安全和可用性。我们可以在给定时间内计算完成的”循环“取决于提供我们应用程序的计算资源。在 0.25 到 0.5 秒之间的时间内散列密码是一个很好的体验。我们应该尝试使用的”循环“至少为 12。</p>
<p>为了测试散列密码花费的时间，我们可以编写一个简单且快速的散列密码的 Python 脚本。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># benchmark.py</span>

<span class="kn">from</span> <span class="nn">flask.ext.bcrypt</span> <span class="kn">import</span> <span class="n">generate_password_hash</span>

<span class="c"># Change the number of rounds (second argument) until it takes between</span>
<span class="c"># 0.25 and 0.5 seconds to run.</span>
<span class="n">generate_password_hash</span><span class="p">(</span><span class="s">&#39;password1&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>现在我们可以使用 UNIX 的 <code class="docutils literal"><span class="pre">time</span></code> 工具来记录时间的消耗数。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre>$ time python test.py

real    0m0.496s
user    0m0.464s
sys     0m0.024s
</pre></div>
</td></tr></table></div>
<p>我做了一个快速的基准测试在一个小型的服务器上，12 ”循环“（rounds）是一个很合适的值，因此我们使用它来配置我的示例。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># config.py</span>

<span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">12</span>
</pre></div>
</td></tr></table></div>
<p>现在 Flask-Bcrypt 已经配置好了，是时候开始散列密码。我们可以在接收来自注册表单的请求的视图中手动去散列密码，但是我们必须在密码重置以及密码修改的视图中再次重复这样做。相反，我们要做的就是如何抽象散列，以便我们的应用程序无需我们考虑就能自己完成。这里我们会使用一个 <strong>setter</strong>，这样的话当我们设置 <code class="docutils literal"><span class="pre">user.password</span> <span class="pre">=</span> <span class="pre">'password1'</span></code> 的话，在存储之前就会自动地使用 Bcrypt 散列密码。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/models.py</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bcrypt</span><span class="p">,</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">_password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_password</span>

    <span class="nd">@password.setter</span>
    <span class="k">def</span> <span class="nf">_set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_password</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>我们使用了 SQLAlchemy 的 hybrid 扩展来定义一个属性，这个属性从相同接口调用的时候拥有不同的功能。当我们为 <code class="docutils literal"><span class="pre">user.password</span></code> 属性赋值的时候，我们的 setter 就被调用。在它里面，我们散列一耳光明文的密码并且存储在用户表的 <code class="docutils literal"><span class="pre">_password</span></code> 字段中。因为我们使用 hybrid 属性，我们可以通过相同的 <code class="docutils literal"><span class="pre">user.password</span></code> 属性来访问散列的密码。</p>
<p>现在我们使用上面的模型为应用程序实现一个注册视图。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/views.py</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">EmailPasswordForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/signup&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EmailPasswordForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;signup.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id5">
<h2>认证<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>既然我们在数据库中有用户了，我们可以实现认证。我们要一个用户提交携带他们的用户名和密码的表单（尽管对一些应用来说这可能是邮箱和密码），接着确保他们是否提供了正确的密码。如果所有的都验证通过了，我们通过在他们的浏览器上设置一个 cookie 来标记他们已经通过认证。下一次他们再过来请求的时候我们通过查找 cookie 知道他们已经登录。</p>
<p>让我们开始用 WTForms 定义一个 <code class="docutils literal"><span class="pre">UsernamePassword</span></code> 表单。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/forms.py</span>

<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>


<span class="k">class</span> <span class="nc">UsernamePasswordForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
</pre></div>
</td></tr></table></div>
<p>下一步我们在我们的用户模型中添加一个方法，该方法用来比较一个字符串和用户存储的散列密码。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre># ourapp/models.py

from . import db

class User(db.Model):

    # [...] columns and properties

    def is_correct_password(self, plaintext)
        return bcrypt.check_password_hash(self._password, plaintext)
</pre></div>
</td></tr></table></div>
<div class="section" id="flask-login">
<h3>Flask-Login<a class="headerlink" href="#flask-login" title="Permalink to this headline">¶</a></h3>
<p>我们下一目标就是定义一个登录的视图，该视图用来服务和接收我们的表单。如果用户输入正确的凭证的话，我们将使用 Flask-Login 扩展来认证他们。这个扩展简化了处理用户会话和认证的过程。</p>
<p>我们需要的就是对 Flask-Login 进行一些小小的配置。</p>
<p>在 <em>__init__.py</em> 中，我们将定义 Flask-Login 的 <code class="docutils literal"><span class="pre">login_manager</span></code>。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/__init__.py</span>

<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">LoginManager</span>

<span class="c"># Create and configure app</span>
<span class="c"># [...]</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">login_view</span> <span class="o">=</span>  <span class="s">&quot;signin&quot;</span>

<span class="nd">@login_manager.user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">userid</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">userid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>这里我们创建了一个 <code class="docutils literal"><span class="pre">LoginManager</span></code> 示例，并且用我们的 <code class="docutils literal"><span class="pre">app</span></code> 对象初始化它，定义登录视图并且告诉它如何用一个的用户的 <code class="docutils literal"><span class="pre">id</span></code> 得到用户对象。这是我们使用 Flask-Login 的最基本的配置。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">查看更多 <a class="reference external" href="https://flask-login.readthedocs.org/en/latest/#customizing-the-login-process">自定义 Flask-Login 的方法</a>.</p>
</div>
<p>现在我们可以定义处理登录的 <code class="docutils literal"><span class="pre">signin</span></code> 视图。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre># ourapp/views.py

from flask import redirect, url_for

from flask.ext.login import login_user

from . import app
from .forms import UsernamePasswordForm()

@app.route(&#39;signin&#39;, methods=[&quot;GET&quot;, &quot;POST&quot;])
def signin():
    form = UsernamePasswordForm()

    if form.validate_on_submit():
        user = User.query.filter_by(username=form.username.data).first_or_404()
        if user.is_correct_password(form.password.data):
            login_user(user)

            return redirect(url_for(&#39;index&#39;))
        else:
            return redirect(url_for(&#39;signin&#39;))
    return render_template(&#39;signin.html&#39;, form=form)
</pre></div>
</td></tr></table></div>
<p>我们简单地从 Flask-Login 中导入 <code class="docutils literal"><span class="pre">login_user</span></code> 函数，检查用户登录凭证并且调用 <code class="docutils literal"><span class="pre">login_user(user)</span></code>。你可以使用 <code class="docutils literal"><span class="pre">logout_user()</span></code> 实现用户的退出操作。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/views.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">logout_user</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/signout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">signout</span><span class="p">():</span>
    <span class="n">logout_user</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id7">
<h2>忘记密码<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>我们通常要实现一个”忘记你的密码“的功能，允许一个用户通过邮箱找回自己的账号。这个地方也会有很多潜在的风险，因为关键是让一个未认证的用户接管一个账号。我们这里实现密码重置采用了我们在邮箱确认的时候一些同样的技术。</p>
<p>我们需要一个表单用来申请为某个账号的邮箱重置密码，并且需要一个表单就来让用书输入新的密码，一旦我们已经确认了未经认证的用户能够访问某个账号的邮箱。在本节的代码假设我们的用户模型有一个邮箱和密码，并且密码是我们之前创建的具有 hybrid 属性。</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">不要发送密码重置链接到一个未经证实的电子邮件地址！你要确保你正在发送链接给合适的人。</p>
</div>
<p>我们将需要两个表单。一个是用于申请重置密码的链接，一个是用于一旦邮件被认证用于更改密码。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/forms.py</span>

<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Email</span>

<span class="k">class</span> <span class="nc">EmailForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="s">&#39;Email&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Email</span><span class="p">()])</span>

<span class="k">class</span> <span class="nc">PasswordForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">&#39;Email&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
</pre></div>
</td></tr></table></div>
<p>上面的代码假设我们的密码重置的表单只需要一个密码字段（只需要输入一次新密码）。许多应用程序需要用户输入新的密码两次以确保他们没有输错。要做到这一点的话，我们可以简单地添加另一个 <code class="docutils literal"><span class="pre">PasswordField</span></code> 字段，并且添加 <code class="docutils literal"><span class="pre">EqualTo</span></code> WTForms 的验证器。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>用户体验社区（UX）有很多关于处理注册表单的最佳方式的有趣的讨论。我个人十分喜欢 Stack Exchange 用户（Roger Attrill）的想法，他这样说的：</p>
<p>”我们不应该要求用户输入密码两次 - 我们只需要用户输入一次并且确保‘忘记密码’的功能要完美和无缝的。“</p>
<ul class="last simple">
<li>在 <a class="reference external" href="http://ux.stackexchange.com/questions/20953/why-should-we-ask-the-password-twice-during-registration/21141">Stack Exchange 用户体验跟帖</a> 查看更多关于该话题的内容。</li>
<li>在 <a class="reference external" href="http://uxdesign.smashingmagazine.com/2011/05/05/innovative-techniques-to-simplify-signups-and-logins/">Smashing Magazine 的文章</a> 上也有很多关于简化注册和登录表单的很酷的想法。</li>
</ul>
</div>
<p>现在我们实现第一个视图，用户可以申请发送密码重置链接到一个指定的邮箱地址。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre># ourapp/views.py

from flask import redirect, url_for, render_template

from . import app
from .forms import EmailForm
from .models import User
from .util import send_email, ts

@app.route(&#39;/reset&#39;, methods=[&quot;GET&quot;, &quot;POST&quot;])
def reset():
    form = EmailForm()
    if form.validate_on_submit()
        user = User.query.filter_by(email=form.email.data).first_or_404()

        subject = &quot;Password reset requested&quot;

        # Here we use the URLSafeTimedSerializer we created in `util` at the
        # beginning of the chapter
        token = ts.dumps(user.email, salt=&#39;recover-key&#39;)

        recover_url = url_for(
            &#39;reset_with_token&#39;,
            token=token,
            _external=True)

        html = render_template(
            &#39;email/recover.html&#39;,
            recover_url=recover_url)

        # Let&#39;s assume that send_email was defined in myapp/util.py
        send_email(user.email, subject, html)

        return redirect(url_for(&#39;index&#39;))
    return render_template(&#39;reset.html&#39;, form=form)
</pre></div>
</td></tr></table></div>
<p>当表单接收到一个邮箱地址，我们获取与该邮箱地址有关的用户，生成一个重置的令牌并且发送他们一个密码重置的 URL。这个 URL 将他们路由到一个视图，该视图验证令牌并且让他们重置密码。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/views.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">PasswordForm</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">ts</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/reset/&lt;token&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">reset_with_token</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="s">&quot;recover-key&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">86400</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">PasswordForm</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_404</span><span class="p">()</span>

        <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;signin&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;reset_with_token.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>我们使用了和验证用户的邮箱地址一样的令牌验证方法。视图把从 URL 中获取的令牌传入到模板中。接着模板使用令牌提交表单到正确的 URL。让我们看看模板可能的样子。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre>{# ourapp/templates/reset_with_token.html #}

{% extends &quot;layout.html&quot; %}

{% block body %}
&lt;form action=&quot;{{ url_for(&#39;reset_with_token&#39;, token=token) }}&quot; method=&quot;POST&quot;&gt;
    {{ form.password.label }}: {{ form.password }}&lt;br&gt;
    {{ form.csrf_token }}
    &lt;input type=&quot;submit&quot; value=&quot;Change my password&quot; /&gt;
&lt;/form&gt;
{% endblock %}
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id8">
<h2>摘要<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>使用 itsdangerous 包来创建和验证发送到邮箱地址的令牌。</li>
<li>当一个用户创建账号，更改邮箱或者忘记密码的时候，你可以使用这些令牌来验证邮件。</li>
<li>使用 Flask-Login 扩展来认证用户可以避免自己处理一大堆麻烦的会话管理。</li>
<li>要经常思考一个恶意的用户如何滥用你的应用程序去做一些你不打算做的事情。</li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="deployment.html" class="btn btn-neutral float-right" title="部署"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="forms.html" class="btn btn-neutral" title="处理表单"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Robert Picard.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50579609-1', 'exploreflask.com');
  ga('send', 'pageview');

</script>


</body>
</html>