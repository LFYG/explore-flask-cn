

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>处理表单 &mdash; Explore Flask 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Explore Flask 1.0 documentation" href="index.html"/>
        <link rel="next" title="处理用户的模式" href="users.html"/>
        <link rel="prev" title="存储数据" href="storing.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Explore Flask</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">前言</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id2">假设</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id8">动态文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id9">本书使用的约定</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id13">彩蛋</a></li>
<li class="toctree-l2"><a class="reference internal" href="preface.html#id14">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">编码约定</a><ul>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#pep">让我们来个 PEP 动员！</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#id3">相对导入</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventions.html#id4">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="environment.html">环境</a><ul>
<li class="toctree-l2"><a class="reference internal" href="environment.html#virtualenv">使用 virtualenv 管理你的环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id6">版本控制</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id8">调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html#id12">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="organizing.html">组织你的项目</a><ul>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id2">定义</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id4">组织模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="organizing.html#id10">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">配置</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id2">简单的例子</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id3">实例文件夹</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id8">基于环境变量配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="views.html">视图和路由的高级模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="views.html#id2">视图装饰器</a></li>
<li class="toctree-l2"><a class="reference internal" href="views.html#url-converters">URL 转换器(converters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="views.html#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="blueprints.html">蓝图</a><ul>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id2">什么是蓝图？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id3">为什么要使用蓝图？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id5">你把它们放哪里？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id9">你如何使用它们？</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id12">使用蓝图重构小的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="blueprints.html#id18">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">模板</a><ul>
<li class="toctree-l2"><a class="reference internal" href="templates.html#jinja">Jinja 快速入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id3">如何组织模板</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id4">继承</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id6">创建宏</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id9">自定义过滤器</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html#id11">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="static.html">静态文件</a><ul>
<li class="toctree-l2"><a class="reference internal" href="static.html#id2">组织你的静态文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#flask-assets">使用 Flask-Assets 管理静态资源</a></li>
<li class="toctree-l2"><a class="reference internal" href="static.html#id7">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="storing.html">存储数据</a><ul>
<li class="toctree-l2"><a class="reference internal" href="storing.html#sqlalchemy">SQLAlchemy</a></li>
<li class="toctree-l2"><a class="reference internal" href="storing.html#id5">摘要</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">处理表单</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#flask-wtf">Flask-WTF</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="users.html">处理用户的模式</a><ul>
<li class="toctree-l2"><a class="reference internal" href="users.html#id2">确认电子邮箱</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id3">存储密码</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id5">认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id7">忘记密码</a></li>
<li class="toctree-l2"><a class="reference internal" href="users.html#id8">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">部署</a><ul>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id2">主机</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id3">部署方式</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html#id7">摘要</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">结尾</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Explore Flask</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>处理表单</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/forms.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="id1">
<h1>处理表单<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<img alt="Handling forms" src="_images/forms.png" />
<p>表单是让用户与我们的网页应用程序交互的基本元素。Flask 本身并不会帮助我们处理表单，但是 Flask-WTF 扩展让我们在我们的 Flask 应用程序中使用流行的 WTForms 包。这个包使得定义表单和处理提交容易一些。</p>
<div class="section" id="flask-wtf">
<h2>Flask-WTF<a class="headerlink" href="#flask-wtf" title="Permalink to this headline">¶</a></h2>
<p>我们想要使用 Flask-WTF 做的第一件事情（在安装它以后）就是在 <code class="docutils literal"><span class="pre">myapp.forms</span></code> 包中定义一个表单。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/forms.py</span>

<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Email</span>

<span class="k">class</span> <span class="nc">EmailPasswordForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">&#39;Email&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Email</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>在 Flask-WTF 版本 0.9 以前，Flask-WTF 提供了针对 WTForms 字段以及验证器的自己的封装。你可能看到外面一大堆的代码是从 <code class="docutils literal"><span class="pre">flask.ext.wtforms</span></code> 中不是从 <code class="docutils literal"><span class="pre">wtforms</span></code> 中导入 <code class="docutils literal"><span class="pre">TextField</span></code>，<code class="docutils literal"><span class="pre">PasswordField</span></code>。</p>
<p class="last">在 Flask-WTF 版本 0.9 以后，我们应该直接从 <code class="docutils literal"><span class="pre">wtforms</span></code> 中导入这些字段和验证器。</p>
</div>
<p>我们定义的表单是一个用户登录表单。我们把它叫做 <code class="docutils literal"><span class="pre">EmailPasswordForm()</span></code>，我们可以重用这个同样的表单类（<code class="docutils literal"><span class="pre">Form</span></code>）去做其它的一些事情，像注册表单。这里我们没有去定义一个又长又没有用的表单，而是选择一个很常用的表单，只是为了给你们介绍使用 Flask-WTF 定义表单的方式。也许以后在正式项目中会定义一个特别复杂表单。对于表单中包含字段名称，我们建议使用一个清楚的名称，并且在一个表单中保持唯一。不得不说，对于一个长的表单，我们可能要给出一个更符合上文的字段名称。</p>
<p>登录表单可以替我们做一些事情。它能够保证我们应用程序的安全以防止 CSRF 漏洞，验证用户输入并且渲染适当的标记，这些标记是我们为表单定义的字段。</p>
<div class="section" id="csrf">
<h3>CSRF 保护和验证<a class="headerlink" href="#csrf" title="Permalink to this headline">¶</a></h3>
<p>CSRF 表示跨站请求伪造。CSRF 攻击是指第三方伪造（像一个表单提交）请求到一个应用程序的服务器。一个易受攻击的服务器假设从一个表单来的数据是来自它自己的网站并且采取相应的操作。</p>
<p>作为一个例子，比方说，一个邮件提供商可以让你通过提交一个表单来删除你的账号。表单发送一个 POST 请求到服务器上的 <code class="docutils literal"><span class="pre">account_delete</span></code> 端点并且当表单被提交的时候删除登录的账号。我们可以在自己的网站上创建一个表单，该表单发送一个 POST 请求到同一个 <cite>account_delete`</cite> 端点。现在，如果我们让某人点击我们表单的提交按钮（或者通过 JavaScript 来这样做），邮件提供商提供的登录账号就会被删除掉。当然邮件提供商还不知道表单提交并不是发生在他们的网站上。</p>
<p>因此如何才能阻止 POST 请求来自别的网站？WTForms 通过在渲染每一个表单的时候生成一个唯一的令牌使得成为可能。生成的令牌会被传回到服务器，伴随着 POST 请求的数据，在表单被接受之前令牌必须接受服务器的验证。关键的是令牌是与存储在用户会话（cookies）的一个值有关并且会在一段时间后回去（默认是 30 分钟）。这种方式就能够保证提交一个有效表单的人就是加载页面的人（或者至少是使用同一电脑的人），而且他们只能在加载页面 30 分钟内这样做。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li><a class="reference external" href="http://wtforms.simplecodes.com/docs/1.0.1/ext.html#module-wtforms.ext.csrf.session">在文档中</a> 了解更多关于 WTForms 如何生成这些令牌。</li>
<li>在 <a class="reference external" href="https://www.owasp.org/index.php/CSRF">OWASP wiki</a> 中了解 CSRF。</li>
</ul>
</div>
<p>要开始使用 Flask-WTF 保护 CSRF，我们需要为我们的登录页定义一个视图。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/views.py</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">EmailPasswordForm</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">EmailPasswordForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>

        <span class="c"># Check the password and log the user in</span>
        <span class="c"># [...]</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;login.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>我们从 <code class="docutils literal"><span class="pre">forms</span></code> 包中导入我们的表单并且在视图中实例化它。接着我们运行 <code class="docutils literal"><span class="pre">form.validate_on_submit()</span></code>。如果表单被提交（例如，如果 HTTP 方法是 PUT 或者 POST）并且通过我们定义在 <em>forms.py</em> 中的验证器验证过，这个函数（<code class="docutils literal"><span class="pre">form.validate_on_submit()</span></code>）将会返回 <code class="docutils literal"><span class="pre">True</span></code>。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li><a class="reference external" href="https://flask-wtf.readthedocs.org/en/latest/api.html#flask_wtf.Form.validate_on_submit">关于 Form.validate_on_submit 的文档</a></li>
<li><a class="reference external" href="https://github.com/lepture/flask-wtf/blob/v0.9.5/flask_wtf/form.py#L151">关于 Form.validate_on_submit 的源码</a></li>
</ul>
</div>
<p>如果表单已经被提交和验证的话，我们可以继续登录的逻辑。如果它没有被提交的话（例如，只是一个 GET 请求），我们就要把表单对象传递给我们的模板，以便它能够后被渲染。下面就是我们使用 CSRF 保护的时候模板的样子。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre>{# ourapp/templates/login.html #}

{% extends &quot;layout.html&quot; %}
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Login Page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;form action=&quot;{{ url_for(&#39;login&#39;) }}&quot; method=&quot;post&quot;&gt;
            &lt;input type=&quot;text&quot; name=&quot;email&quot; /&gt;
            &lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt;
            {{ form.csrf_token }}
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</td></tr></table></div>
<p><code class="docutils literal"><span class="pre">{{</span> <span class="pre">form.csrf_token</span> <span class="pre">}}</span></code> 渲染了一个隐藏的字段，该字段包含那些奇特的 CSRF 令牌，并且当 WTForms 验证表单的时候会寻找这个字段。我们不用担心包含处理令牌的逻辑，WTForms 会主动帮我们去做。好哇！</p>
<div class="section" id="csrf-ajax">
<h4>使用 CSRF 令牌保护 AJAX 调用<a class="headerlink" href="#csrf-ajax" title="Permalink to this headline">¶</a></h4>
<p>Flask-WTF CSRF 令牌不限于保护表单提交。如果你的应用程序要处理其它可能会被伪造的请求（特别是 AJAX 调用），你也可以在那里添加 CSRF 保护！</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Flask-WTF 文档中谈到了更多地关于 <a class="reference external" href="https://flask-wtf.readthedocs.org/en/latest/csrf.html#ajax">在 AJAX 调用中使用这些 CSRF 令牌</a>。</p>
</div>
</div>
</div>
<div class="section" id="id4">
<h3>自定义验证<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>除了由 WTForms 提供的内置的表单验证器（例如，<code class="docutils literal"><span class="pre">Required()</span></code>，<code class="docutils literal"><span class="pre">Email()</span></code> 等等），我们能创建我们自己的验证器。我们将通过编写一个 <code class="docutils literal"><span class="pre">Unique()</span></code> 验证器来说明创建自己的验证器，<code class="docutils literal"><span class="pre">Unique()</span></code> 验证器是用来检查数据库并且确保用户提供的值在数据库中不存在。这能够用于确保用户名或者邮箱地址还没有使用。没有 WTForms 的话，我们可能要在视图中做这些事情，但是现在我们可以在表单本身做些事情。</p>
<p>现在我们来定义一个简单的注册表单，其实这个表单和登录的表单几乎一样。只是会在后面给它添加一些自定义的验证器。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/forms.py</span>

<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span><span class="p">,</span> <span class="n">Email</span>

<span class="k">class</span> <span class="nc">EmailPasswordForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">&#39;Email&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Email</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
</pre></div>
</td></tr></table></div>
<p>现在我们要添加我们的验证器用来确保它们提供的邮箱不存在数据库中。我们把这个验证器放在一个新的 <code class="docutils literal"><span class="pre">util</span></code> 模块，<code class="docutils literal"><span class="pre">util.validators</span></code>。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/util/validators.py</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="k">class</span> <span class="nc">Unique</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">u&#39;This element already exists.&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>这个验证器假设我们是使用 SQLAlchemy 来定义我们的模型。WTForms 期待验证器返回某种可调用的对象（例如，一个可调用的类）。</p>
<p>在 <code class="docutils literal"><span class="pre">Unique()</span></code> 的 <code class="docutils literal"><span class="pre">__init__</span></code> 中我们可以指定哪些参数传入到验证器中，在本例中我们要传入相关的模型（例如，在我们的情况中式传入 <code class="docutils literal"><span class="pre">User</span></code> 模型）以及要检查的字段。当验证器被调用的时候，如果定义模型的任何实例匹配表单中提交的值，它将会抛出一个 <code class="docutils literal"><span class="pre">ValidationError</span></code>。我们也可以添加一个具有通用默认值的消息，它将会被包含在 <code class="docutils literal"><span class="pre">ValidationError</span></code> 中。</p>
<p>现在我们可以修改 <code class="docutils literal"><span class="pre">EmailPasswordForm</span></code>，使用我们自定义的 <code class="docutils literal"><span class="pre">Unique</span></code> 验证器。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># ourapp/forms.py</span>

<span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">PasswordField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>

<span class="kn">from</span> <span class="nn">.util.validators</span> <span class="kn">import</span> <span class="n">Unique</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">EmailPasswordForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">&#39;Email&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">(),</span> <span class="n">Email</span><span class="p">(),</span>
        <span class="n">Unique</span><span class="p">(</span>
            <span class="n">User</span><span class="p">,</span>
            <span class="n">User</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s">&#39;There is already an account with that email.&#39;</span><span class="p">)])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">我们的验证器不必须是一个可调用的类。它也可能是返回可调用或者直接调用的一个工厂模式。WTForms 文档中有 <a class="reference external" href="http://wtforms.simplecodes.com/docs/0.6.2/validators.html#custom-validators">一些例子</a>。</p>
</div>
</div>
<div class="section" id="id6">
<h3>渲染表单<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>WTForms 也能帮助我们为表单渲染成 HTML 表示。WTForms 实现的 <code class="docutils literal"><span class="pre">Field</span></code> 字段能够渲染成该字段的 HTML 表示，所以为了渲染它们，我们只必须在我们模板中调用表单的字段。这就像渲染 <code class="docutils literal"><span class="pre">csrf_token</span></code> 字段。下面给出了一个登录模板的示例，在里面我们使用 WTForms 来渲染我们的字段。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre>{# ourapp/templates/login.html #}

{% extends &quot;layout.html&quot; %}
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Login Page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
            {{ form.email }}
            {{ form.password }}
            {{ form.csrf_token }}
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</td></tr></table></div>
<p>我们可以自定义如何渲染字段，通过传入字段的属性作为参数到调用中。</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre>&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
    {{ form.email.label }}: {{ form.email(placeholder=&#39;yourname@email.com&#39;) }}
    &lt;br&gt;
    {{ form.password.label }}: {{ form.password }}
    &lt;br&gt;
    {{ form.csrf_token }}
&lt;/form&gt;
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果我们想要传入 “class” HTML 属性，我们必须使用 <code class="docutils literal"><span class="pre">class_=''</span></code> 因为 “class” 是 Python 中的保留关键字。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">WTForms 文档中有一个 <a class="reference external" href="http://wtforms.simplecodes.com/docs/1.0.4/fields.html#wtforms.fields.Field.name">可用字段属性列表</a>。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>你可能注意到我们没有必须要使用 Jinja 的 <code class="docutils literal"><span class="pre">|safe</span></code> 过滤器。这是因为 WTForms 渲染 HTML 安全字符串。</p>
<p class="last">更多的内容请参阅 <a class="reference external" href="https://flask-wtf.readthedocs.org/en/v0.8.4/#using-the-safe-filter">官方文档</a>。</p>
</div>
</div>
</div>
<div class="section" id="id9">
<h2>摘要<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>表单从安全性的角度是很可怕的。</li>
<li>WTForms（以及 Flask-WTF）使得容易地定义，保护以及渲染你的表单。</li>
<li>使用 Flask-WTF 提供的 CSRF 保护可以确保你的表单的安全。</li>
<li>你也可以使用 Flask-WTF 来保护你的 AJAX 调用以防止 CSRF 攻击。</li>
<li>定义自定义的表单验证器可以让验证逻辑远离视图。</li>
<li>使用 WTForms 字段渲染来渲染你的表单的 HTML，在你对你的表单定义做出一些改变的时候，你不必每次都更新它。</li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="users.html" class="btn btn-neutral float-right" title="处理用户的模式"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="storing.html" class="btn btn-neutral" title="存储数据"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Robert Picard.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-50579609-1', 'exploreflask.com');
  ga('send', 'pageview');

</script>


</body>
</html>